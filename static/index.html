<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APK Decompiler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex flex-col h-screen bg-gray-100 overscroll-y-contain">
<header class="bg-blue-600 text-white p-4">
    <h1 class="text-sm font-bold">APK Decompiler</h1>
</header>

<div class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-200 p-4 overflow-y-auto">
        <input type="file" id="fileInput" accept=".apk,.xapk" class="mb-4">
        <button onclick="uploadFile()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Upload and
            Decompile
        </button>
        <div id="fileList" class="mt-4 whitespace-nowrap"></div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-4 overflow-auto">
        <pre id="fileContent" class="bg-white p-4 rounded shadow"></pre>
    </main>
</div>

<!-- Logger -->
<footer class="h-48 bg-gray-800 text-white p-4 overflow-y-auto">
    <div id="consoleOutput"></div>
</footer>

<script>
    const output = document.getElementById('consoleOutput');

    const socket = io({
        transports: ['websocket'],
        upgrade: false
    });

    socket.on('connect', () => {
        console.log('Connected to server');
        logToConsole('Connected to server');
    });

    socket.on('console_output', (data) => logToConsole(data.data));

    socket.on('decompile_complete', (data) => {
        if (data.status === 'success') {
            logToConsole('Decompilation completed successfully');
        } else {
            logToConsole('Decompilation failed');
        }
        listFiles();
    });

    function logToConsole(data) {
        output.innerHTML += data + '<br>';
        output.scrollTop = output.scrollHeight;
    }

    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            await axios.post('/upload', formData);
            logToConsole('Decompilation started...');
        } catch (error) {
            logToConsole('Error: ' + error.response.data);
        }
    }

    async function listFiles() {
        try {
            const response = await axios.get('/files');
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            response.data.files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.textContent = file;
                fileItem.className = 'cursor-pointer hover:bg-gray-300 p-1 rounded';
                fileItem.onclick = () => getFileContent(file);
                fileList.appendChild(fileItem);
            });
        } catch (error) {
            logToConsole('Error: ' + error);
        }
    }

    async function getFileContent(filepath) {
        try {
            const response = await axios.get(`/file/${encodeURIComponent(filepath)}`, {responseType: 'text'});
            const fileContent = document.getElementById('fileContent');
            fileContent.textContent = response.data;
        } catch (error) {
            if (error.response && error.response.status === 404) {
                logToConsole(`File not found: ${error.response.data.path}`);
            } else {
                logToConsole('An error occurred while fetching the file content');
            }
        }
    }

    listFiles();
</script>
</body>
</html>